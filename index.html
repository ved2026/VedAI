<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Universal AI Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 h-screen overflow-hidden">
  <div class="flex h-full">

    <!-- Sidebar -->
    <aside class="w-64 bg-gray-900 text-gray-100 flex flex-col">
      <div class="p-4 flex items-center justify-between border-b border-gray-700">
        <h1 class="font-semibold">AI Chats</h1>
        <button id="newChatBtn" class="text-sm text-blue-400 hover:underline">
          New
        </button>
      </div>

      <div id="chatList" class="flex-1 overflow-y-auto p-2 space-y-1"></div>

      <div class="p-4 border-t border-gray-700">
        <button
          id="settingsBtn"
          class="w-full bg-gray-800 hover:bg-gray-700 text-sm py-2 rounded"
        >
          Settings
        </button>
      </div>
    </aside>

    <!-- Main Chat Area -->
    <main class="flex-1 flex flex-col">
      <div id="chatHeader" class="p-4 bg-white border-b font-medium">
        New Chat
      </div>

      <div
        id="chatMessages"
        class="flex-1 overflow-y-auto p-6 space-y-4 bg-gray-50"
      ></div>

      <div class="p-4 bg-white border-t">
        <form id="chatForm" class="flex gap-2">
          <textarea
            id="userInput"
            rows="1"
            placeholder="Send a message..."
            class="flex-1 resize-none border rounded px-3 py-2 focus:outline-none focus:ring"
          ></textarea>
          <button
            type="submit"
            class="bg-blue-600 text-white px-4 rounded hover:bg-blue-700"
          >
            Send
          </button>
        </form>
      </div>
    </main>
  </div>

  <!-- Settings Modal -->
  <div
    id="settingsModal"
    class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center"
  >
    <div class="bg-white w-full max-w-md rounded shadow-lg p-6 space-y-4">
      <h2 class="text-lg font-semibold">Settings</h2>

      <div>
        <label class="block text-sm font-medium mb-1">OpenRouter API Key</label>
        <input
          id="apiKeyInput"
          type="password"
          class="w-full border rounded px-3 py-2"
          placeholder="sk-or-..."
        />
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">Model Name</label>
        <input
          id="modelInput"
          type="text"
          class="w-full border rounded px-3 py-2"
          placeholder="openai/gpt-4o-mini"
        />
      </div>

      <div class="flex justify-end gap-2 pt-2">
        <button
          id="closeSettingsBtn"
          class="px-4 py-2 border rounded"
        >
          Cancel
        </button>
        <button
          id="saveSettingsBtn"
          class="px-4 py-2 bg-blue-600 text-white rounded"
        >
          Save
        </button>
      </div>
    </div>
  </div>

  <!-- App Script (end of body, as requested) -->
  <script>
    /* -------------------------
       State & Persistence
    --------------------------*/
    const STORAGE_KEY = "universal-ai-chat";
    const SETTINGS_KEY = "universal-ai-settings";

    let state = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
      chats: [],
      activeChatId: null,
    };

    let settings = JSON.parse(localStorage.getItem(SETTINGS_KEY)) || {
      apiKey: "",
      model: "openai/gpt-4o-mini",
    };

    /* -------------------------
       DOM References
    --------------------------*/
    const chatListEl = document.getElementById("chatList");
    const chatMessagesEl = document.getElementById("chatMessages");
    const chatHeaderEl = document.getElementById("chatHeader");
    const userInputEl = document.getElementById("userInput");

    const settingsModal = document.getElementById("settingsModal");
    const apiKeyInput = document.getElementById("apiKeyInput");
    const modelInput = document.getElementById("modelInput");

    /* -------------------------
       Utility Functions
    --------------------------*/
    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function saveSettings() {
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
    }

    function createNewChat() {
      const id = Date.now().toString();
      state.chats.unshift({
        id,
        title: "New Chat",
        messages: [],
      });
      state.activeChatId = id;
      saveState();
      render();
    }

    function getActiveChat() {
      return state.chats.find(c => c.id === state.activeChatId);
    }

    /* -------------------------
       Rendering
    --------------------------*/
    function renderSidebar() {
      chatListEl.innerHTML = "";
      state.chats.forEach(chat => {
        const btn = document.createElement("button");
        btn.className =
          "w-full text-left px-3 py-2 rounded text-sm truncate " +
          (chat.id === state.activeChatId
            ? "bg-gray-700"
            : "hover:bg-gray-800");

        btn.textContent = chat.title;
        btn.onclick = () => {
          state.activeChatId = chat.id;
          saveState();
          render();
        };
        chatListEl.appendChild(btn);
      });
    }

    function renderMessages() {
      chatMessagesEl.innerHTML = "";
      const chat = getActiveChat();
      if (!chat) return;

      chatHeaderEl.textContent = chat.title;

      chat.messages.forEach(msg => {
        const bubble = document.createElement("div");
        bubble.className =
          msg.role === "user"
            ? "max-w-xl ml-auto bg-blue-600 text-white p-3 rounded-lg"
            : "max-w-xl bg-white border p-3 rounded-lg";

        bubble.textContent = msg.content;
        chatMessagesEl.appendChild(bubble);
      });

      chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    }

    function render() {
      renderSidebar();
      renderMessages();
    }

    /* -------------------------
       API Call (OpenRouter)
    --------------------------*/
    async function sendMessage(content) {
      const chat = getActiveChat();
      if (!chat) return;

      chat.messages.push({ role: "user", content });
      if (chat.messages.length === 1) {
        chat.title = content.slice(0, 30);
      }
      render();
      saveState();

      const assistantMsg = { role: "assistant", content: "..." };
      chat.messages.push(assistantMsg);
      render();

      try {
        const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + settings.apiKey,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            model: settings.model,
            messages: chat.messages.filter(m => m.role !== "assistant" || m.content !== "..."),
          }),
        });

        const data = await res.json();
        assistantMsg.content =
          data.choices?.[0]?.message?.content || "No response.";
      } catch (err) {
        assistantMsg.content = "Error contacting API.";
      }

      render();
      saveState();
    }

    /* -------------------------
       Event Bindings
    --------------------------*/
    document.getElementById("newChatBtn").onclick = createNewChat;

    document.getElementById("chatForm").onsubmit = e => {
      e.preventDefault();
      const text = userInputEl.value.trim();
      if (!text) return;
      userInputEl.value = "";
      sendMessage(text);
    };

    document.getElementById("settingsBtn").onclick = () => {
      apiKeyInput.value = settings.apiKey;
      modelInput.value = settings.model;
      settingsModal.classList.remove("hidden");
      settingsModal.classList.add("flex");
    };

    document.getElementById("closeSettingsBtn").onclick = () => {
      settingsModal.classList.add("hidden");
    };

    document.getElementById("saveSettingsBtn").onclick = () => {
      settings.apiKey = apiKeyInput.value.trim();
      settings.model = modelInput.value.trim();
      saveSettings();
      settingsModal.classList.add("hidden");
    };

    /* -------------------------
       Initial Boot
    --------------------------*/
    if (!state.activeChatId) {
      createNewChat();
    } else {
      render();
    }
  </script>
</body>
</html>
